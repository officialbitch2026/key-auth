<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      color: #e2e8f0;
      transition: background 0.3s, color 0.3s;
    }
    body.theme-dark { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
    body.theme-light { background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); color: #1e293b; }
    body.theme-red { background: linear-gradient(135deg, #1c1917 0%, #450a0a 100%); }
    body.theme-blue { background: linear-gradient(135deg, #0c4a6e 0%, #1e3a5f 100%); }
    body.theme-green { background: linear-gradient(135deg, #052e16 0%, #14532d 100%); }

    .sidebar {
      width: 220px;
      min-width: 220px;
      background: rgba(15, 23, 42, 0.95);
      padding: 20px 0;
      border-right: 1px solid rgba(148, 163, 184, 0.2);
    }
    body.theme-light .sidebar { background: rgba(241, 245, 249, 0.95); border-color: rgba(100, 116, 139, 0.3); }
    .sidebar a, .sidebar button {
      display: block;
      width: 100%;
      padding: 12px 20px;
      text-align: left;
      border: none;
      background: none;
      color: #94a3b8;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.2s, color 0.2s;
    }
    body.theme-light .sidebar a, body.theme-light .sidebar button { color: #475569; }
    .sidebar a:hover, .sidebar button:hover {
      background: rgba(59, 130, 246, 0.2);
      color: #38bdf8;
    }
    body.theme-light .sidebar a:hover, body.theme-light .sidebar button:hover { color: #0284c7; }
    .sidebar .active { background: rgba(59, 130, 246, 0.3); color: #38bdf8; font-weight: 600; }
    body.theme-light .sidebar .active { color: #0284c7; }

    .main {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
    }
    .expiry-box {
      text-align: center;
      padding: 40px;
      margin-bottom: 32px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    body.theme-light .expiry-box { background: rgba(255,255,255,0.8); border-color: rgba(100,116,139,0.2); }
    .expiry-label { font-size: 14px; color: #94a3b8; margin-bottom: 8px; }
    .expiry-value {
      font-size: 48px;
      font-family: 'Consolas', monospace;
      font-weight: 700;
      color: #38bdf8;
      letter-spacing: 4px;
    }
    body.theme-light .expiry-value { color: #0284c7; }
    .expiry-value.expired { color: #f87171; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card {
      background: rgba(30, 41, 59, 0.8);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    body.theme-light .card { background: rgba(255,255,255,0.9); border-color: rgba(100,116,139,0.2); }
    .card h2 { font-size: 20px; margin-bottom: 16px; }
    .card p, .card label { font-size: 14px; color: #94a3b8; margin-bottom: 8px; }
    body.theme-light .card p, body.theme-light .card label { color: #64748b; }
    input, select {
      width: 100%;
      max-width: 320px;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #475569;
      background: #0f172a;
      color: #e2e8f0;
      font-size: 14px;
      margin-bottom: 12px;
    }
    body.theme-light input, body.theme-light select { background: #fff; color: #1e293b; border-color: #cbd5e1; }
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      background: #3b82f6;
      color: white;
    }
    .btn:hover { background: #2563eb; }
    .btn-success { background: #10b981; }
    .btn-success:hover { background: #059669; }
    .link-btn {
      display: inline-block;
      padding: 12px 24px;
      background: #5865f2;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      margin: 8px 8px 8px 0;
    }
    .link-btn:hover { background: #4752c4; }
    .link-btn.yt { background: #ff0000; }
    .link-btn.yt:hover { background: #cc0000; }
    .status { margin-top: 12px; font-size: 13px; min-height: 18px; }
    .status.success { color: #4ade80; }
    .status.error { color: #f87171; }
    .purchase-msg {
      margin-bottom: 16px;
      line-height: 1.6;
      max-width: 480px;
    }
    .theme-opt { display: inline-block; margin: 4px; padding: 8px 16px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
    .theme-opt:hover { border-color: #64748b; }
    .theme-opt.selected { border-color: #38bdf8; }
  </style>
</head>
<body class="theme-dark">
  <aside class="sidebar">
    <button data-tab="discord" class="tab-btn">Discord</button>
    <button data-tab="extend" class="tab-btn">Extend Key</button>
    <button data-tab="settings" class="tab-btn">Settings</button>
    <button data-tab="youtube" class="tab-btn">YouTube</button>
    <button data-tab="purchase" class="tab-btn">Purchase</button>
    <button id="logout-btn" style="margin-top: 20px; color: #f87171;">Logout</button>
  </aside>
  <main class="main">
    <div class="expiry-box">
      <div class="expiry-label">Time left</div>
      <div id="expiry-display" class="expiry-value">00:00:00</div>
    </div>

    <div id="tab-discord" class="tab-content">
      <div class="card">
        <h2>Discord Server</h2>
        <p>Join our community on Discord.</p>
        <a id="discord-link" href="#" target="_blank" class="link-btn">Join Discord</a>
      </div>
    </div>

    <div id="tab-extend" class="tab-content">
      <div class="card">
        <h2>Extend Key</h2>
        <p>Enter a new key to extend your license.</p>
        <input id="extend-key" placeholder="Your new key" />
        <button class="btn btn-success" id="extend-btn">Add time</button>
        <div id="extend-status" class="status"></div>
      </div>
    </div>

    <div id="tab-settings" class="tab-content">
      <div class="card">
        <h2>Change password</h2>
        <label>Current password</label>
        <input type="password" id="old-password" placeholder="Current password" />
        <label>New password</label>
        <input type="password" id="new-password" placeholder="New password" />
        <button class="btn" id="change-pwd-btn">Save password</button>
        <div id="pwd-status" class="status"></div>
      </div>
      <div class="card">
        <h2>Theme</h2>
        <p>Choose the interface theme.</p>
        <span class="theme-opt selected" data-theme="dark">Dark</span>
        <span class="theme-opt" data-theme="light">Light</span>
        <span class="theme-opt" data-theme="red">Red</span>
        <span class="theme-opt" data-theme="blue">Blue</span>
        <span class="theme-opt" data-theme="green">Green</span>
      </div>
    </div>

    <div id="tab-youtube" class="tab-content">
      <div class="card">
        <h2>YouTube Channel</h2>
        <p>Subscribe to our channel.</p>
        <a id="youtube-link" href="#" target="_blank" class="link-btn yt">YouTube</a>
      </div>
    </div>

    <div id="tab-purchase" class="tab-content">
      <div class="card">
        <h2>Purchase</h2>
        <p class="purchase-msg">To purchase additional license time and receive your key, please contact us on our Discord server. Payment and key delivery are handled there.</p>
        <a id="purchase-discord-link" href="#" target="_blank" class="link-btn">Go to Discord</a>
      </div>
    </div>
  </main>

  <script>
    const token = localStorage.getItem('authToken');
    if (!token) {
      window.location.href = '/';
      throw new Error('redirect');
    }

    function api(path, options = {}) {
      const headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token, ...options.headers };
      return fetch(path, { ...options, headers }).then(async (r) => {
        const data = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(data.message || 'Error');
        return data;
      });
    }

    let userData = { expiresAt: null, username: '', theme: 'dark' };

    function pad(n) { return String(n).padStart(2, '0'); }
    function updateCountdown() {
      const el = document.getElementById('expiry-display');
      if (!userData.expiresAt) { el.textContent = '--:--:--'; return; }
      const now = new Date();
      const exp = new Date(userData.expiresAt);
      if (exp <= now) {
        el.textContent = 'EXPIRAT';
        el.classList.add('expired');
        return;
      }
      const ms = exp - now;
      const h = Math.floor(ms / 3600000);
      const m = Math.floor((ms % 3600000) / 60000);
      const s = Math.floor((ms % 60000) / 1000);
      el.textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;
      el.classList.remove('expired');
    }

    async function loadUser() {
      try {
        userData = await api('/api/me');
        document.body.className = 'theme-' + (userData.theme || 'dark');
        document.querySelectorAll('.theme-opt').forEach((o) => {
          o.classList.toggle('selected', o.dataset.theme === (userData.theme || 'dark'));
        });
        updateCountdown();
        setInterval(updateCountdown, 1000);
      } catch (e) {
        localStorage.removeItem('authToken');
        window.location.href = '/';
      }
    }

    async function loadConfig() {
      try {
        const cfg = await fetch('/api/config').then((r) => r.json());
        const discordUrl = cfg.discordUrl || 'https://discord.gg/';
        document.getElementById('discord-link').href = discordUrl;
        document.getElementById('youtube-link').href = cfg.youtubeUrl || 'https://youtube.com/';
        const purchaseLink = document.getElementById('purchase-discord-link');
        if (purchaseLink) purchaseLink.href = discordUrl;
      } catch (_) {}
    }

    document.querySelectorAll('.tab-btn').forEach((btn) => {
      btn.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach((b) => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'));
        btn.classList.add('active');
        const id = 'tab-' + btn.dataset.tab;
        document.getElementById(id).classList.add('active');
      };
    });
    document.querySelector('.tab-btn').click();

    document.getElementById('extend-btn').onclick = async () => {
      const key = document.getElementById('extend-key').value.trim();
      const el = document.getElementById('extend-status');
      el.textContent = 'Processing...';
      el.className = 'status';
      try {
        const data = await api('/api/extend', { method: 'POST', body: JSON.stringify({ key }) });
        userData.expiresAt = data.expiresAt;
        el.textContent = data.message || 'Success!';
        el.className = 'status success';
        document.getElementById('extend-key').value = '';
      } catch (e) {
        el.textContent = e.message;
        el.className = 'status error';
      }
    };

    document.getElementById('change-pwd-btn').onclick = async () => {
      const oldP = document.getElementById('old-password').value;
      const newP = document.getElementById('new-password').value;
      const el = document.getElementById('pwd-status');
      el.textContent = 'Saving...';
      el.className = 'status';
      try {
        await api('/api/change-password', { method: 'POST', body: JSON.stringify({ oldPassword: oldP, newPassword: newP }) });
        el.textContent = 'Password changed.';
        el.className = 'status success';
        document.getElementById('old-password').value = '';
        document.getElementById('new-password').value = '';
      } catch (e) {
        el.textContent = e.message;
        el.className = 'status error';
      }
    };

    document.querySelectorAll('.theme-opt').forEach((opt) => {
      opt.onclick = async () => {
        const theme = opt.dataset.theme;
        try {
          await api('/api/settings', { method: 'PATCH', body: JSON.stringify({ theme }) });
          userData.theme = theme;
          document.body.className = 'theme-' + theme;
          document.querySelectorAll('.theme-opt').forEach((o) => o.classList.toggle('selected', o.dataset.theme === theme));
        } catch (_) {}
      };
    });

    document.getElementById('logout-btn').onclick = async () => {
      try { await api('/api/logout', { method: 'POST' }); } catch (_) {}
      localStorage.removeItem('authToken');
      window.location.href = '/';
    };

    loadUser();
    loadConfig();
  </script>
</body>
</html>
